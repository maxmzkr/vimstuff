#include <cstdlib>
#include <iostream>
#include "./thread.h"

mutex coutmutex;

// 2
void join(void *a) {
  thread *t1 = reinterpret_cast<thread *>(a);
  coutmutex.lock();
  std::cout << "join is joining" << std::endl;
  coutmutex.unlock();
  t1->join();
  coutmutex.lock();
  std::cout << "join has joined" << std::endl;
  coutmutex.unlock();
}

// 1
void child(void *a) {
  coutmutex.lock();
  std::cout << "child func is yeilding" << std::endl;
  coutmutex.unlock();
  thread::yield();
  coutmutex.lock();
  std::cout << "child func is done yeilding" << std::endl;
  coutmutex.unlock();
}

// 0
void parent(void *a) {
  coutmutex.lock();
  std::cout << "parent func" << std::endl;
  coutmutex.unlock();
  thread *t1 = new thread((thread_startfunc_t)child, nullptr);
  thread t2((thread_startfunc_t)join, t1);

  coutmutex.lock();
  std::cout << "parent is yielding" << std::endl;
  coutmutex.unlock();
  thread::yield();
  coutmutex.lock();
  std::cout << "parent is joining" << std::endl;
  coutmutex.unlock();
  t1->join();

  coutmutex.lock();
  std::cout << "joined done thread" << std::endl;
  coutmutex.unlock();
}

int main() {
  cpu::boot(1, (thread_startfunc_t)parent, (void *)100, false, false, 0);
}
