CXXFLAGS := -Wall -Werror -g -j4 -std=c++11
LDFLAGS := -ldl -pthread

OBJS = libcpu.a
TESTS_SRC = $(wildcard test*.cc)
TESTS_OBJECTS = $(TESTS_SRC:%.cc=%.o)
TESTS = $(TESTS_SRC:%.cc=%.out)
THREADLIB = thread.o thread_impl.o mutex.o mutex_impl.o cv.o cv_impl.o cpu.o cpu_impl.o

all: $(THREADLIB) tests

debug: CXXFLAGS += -DDO_VALGRIND
debug: CXXFLAGS += -DDEBUG_BUILD
debug: all

%.o: %.cc
	$(CXX) $(CXXFLAGS) -c $< $(LDFLAGS)

tests: $(TESTS)

test%.o: test%.cc
	$(CXX) $(CXXFLAGS) -c $< $(LDFLAGS)

test%.out: test%.o $(THREADLIB)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(OBJS) $(LDFLAGS)

clean:
	rm -f *~ *.out
	find . -type f -name "*.o" | grep -v "threadsol.o" | xargs rm
